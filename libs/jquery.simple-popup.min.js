(function ($) {

	$.fn.simplePopup = function (options) {

		var defaults = $.extend({
			enableClose: true,
			open: function() {},
			closed: function() {}
		}, options);

		/******************************
		 Private Variables
		 *******************************/

		var object = $(this);
		var settings = $.extend(defaults, options);

		/******************************
		 Public Methods
		 *******************************/

		var methods = {

			init: function() {
				return this.each(function () {
					methods.appendHTML();
					methods.setEventHandlers();
					methods.showPopup();
				});
			},

			/******************************
			 Append HTML
			 *******************************/

			appendHTML: function() {

				// if this has already been added we don't need to add it again
				if ($('.simplePopupBackground').length === 0) {
					var background = '<div class="simplePopupBackground"></div>';
					$('body').prepend(background);
				}

				if(object.find('.simplePopup-close').length === 0 && defaults.enableClose) {
					var close = '<div class="simplePopup-close"></div>';
					object.prepend(close);
				}
			},

			/******************************
			 Set Event Handlers
			 *******************************/

			setEventHandlers: function() {

				if (defaults.enableClose){
					$(".simplePopup-close, .simplePopupBackground").on("click", function (event) {
						methods.hidePopup();
					});

					$(document).on("keyup.escapeKey", function(e) {
						if (e.keyCode === 27) {
							methods.hidePopup();
						}
					});
				}

				$(window).on("resize", function(event){

				});

			},

			removeEventListners: function() {
				$(".simplePopup-close, .simplePopupBackground").off("click");
				$(document).unbind("keyup.escapeKey");
			},

			showPopup: function() {
				$(".simplePopupBackground").css({
					"opacity": "0.7"
				});

				$(".simplePopupBackground").fadeIn("fast");

				object.fadeIn("slow", function(){
					settings.open();
				});
			},

			hidePopup: function() {
				$(".simplePopupBackground").fadeOut("fast");
				object.fadeOut("fast", function(){
					methods.removeEventListners();
					settings.closed();
				});
			}

		};

		if (methods[options]) { // $("#element").pluginName('methodName', 'arg1', 'arg2');
			return methods[options].apply(this, Array.prototype.slice.call(arguments, 1));
		} else if (typeof options === 'object' || !options) { 	// $("#element").pluginName({ option: 1, option:2 });
			return methods.init.apply(this);
		} else {
			$.error( 'Method "' +  method + '" does not exist in simple popup plugin!');
		}
	};

})(jQuery);